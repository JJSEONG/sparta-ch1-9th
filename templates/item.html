<!doctype html>
<html lang="en">
<head>

    <!-- Webpage Title -->
    <title>Detail</title>

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bulma CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
    <!-- Font Awesome CSS -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='/css/mystyle.css') }}" rel="stylesheet">

    <!-- JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>
    <script src="{{ url_for('static', filename='/js/myjs.js') }}"><</script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
    <style>
        .myPic {
            width: 300px;
            height: 300px;

            background-image: linear-gradient(0deg, rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5));
            background-position: center 30%;
            background-size: cover;

            color: white;

            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;

            margin: auto;
            margin-top: 25px;
        }

        img {
            width: 100%;
            height: 100%;
        }

        button.delete {
            display: none;
        }

        div.box:hover button.delete {
            display: block;
        }
    </style>

    <script>
        function post() {
            let comment = $("#textarea-post").val()
            let today = new Date().toISOString()
            $.ajax({
                type: "POST",
                url: "/review",
                data: {
                    comment_give: comment,
                    date_give: today
                },
                success: function (response) {
                    $("#modal-post").removeClass("is-active")
                    window.location.reload()
                }
            })
        }

        function time2str(date) {
            let today = new Date()
            let time = (today - date) / 1000 / 60  // 분

            if (time < 60) {
                return parseInt(time) + "분 전"
            }
            time = time / 60  // 시간
            if (time < 24) {
                return parseInt(time) + "시간 전"
            }
            time = time / 24
            return parseInt(time) + "일 전"
        }

        function num2str(count) {
            if (count > 10000) {
                return parseInt(count / 1000) + "k"
            }
            if (count > 500) {
                return parseInt(count / 100) / 10 + "k"
            }
            if (count == 0) {
                return ""
            }
            return count
        }

        function delete_review(comment_id) {
            Swal.fire({
                title: '삭제하시겠습니까?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: '삭제',
                cancelButtonText: '취소'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        type: "DELETE",
                        url: "/review",
                        data: {
                            comment_id: comment_id,
                        },
                        success: function (response) {
                            if (response['status'] == 200) {
                                Swal.fire({
                                    icon: 'success',
                                    title: '삭제성공.',
                                    showConfirmButton: false,
                                    timer: 1500
                                }).then(() => {
                                    window.location.reload()
                                });
                            } else if (response['status'] == 401) {
                                Swal.fire({
                                    icon: 'error',
                                    title: ' 삭제권한이 없습니다.',
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: '삭제에 실패했습니다.',
                                });
                            }
                        }
                    })
                }
            })
        }

        function get_posts() {
            $("#post-box").empty()
            $.ajax({
                type: "GET",
                url: "/reviews",
                data: {},
                success: function (response) {
                    if (response["result"] == "success") {
                        let reviews = response["reviews"]
                        for (let i = 0; i < reviews.length; i++) {
                            let review = reviews[i]
                            let time_post = new Date(review["date"])
                            let time_before = time2str(time_post)
                            let class_heart = review['heart_by_me'] ? "fa-heart" : "fa-heart-o"
                            let count_heart = review['count_heart']
                            let html_temp = `<div class="box" id="${review["_id"]}"
                                        <article class="media">
                                            <div class="media-left">
                                                <a class="image is-64x64" href="/user/${review['username']}">
                                                    <img class="is-rounded" src="/static/${review['profile_pic_real']}"
                                                         alt="Image">
                                                </a>
<strong>${review['profile_name']}</strong> <small>@${review['username']}</small> <small>${time_before}</small>
                                            </div>
                                            <div class="media-content">
                                                <div class="content">
                                                    <p>

                                                        <br>
                                                        ${review['comment']}
                                                    </p>
                                                </div>
                                                <nav class="level is-mobile">
                                                    <div class="level-left">
                                                        <a class="level-item is-sparta" aria-label="heart" onclick="toggle_like('${post['_id']}', 'heart')">
                                                            <span class="icon is-small"><i class="fa ${class_heart}"
                                                                                           aria-hidden="true"></i></span>&nbsp;<span class="like-num">${count_heart}</span>
                                                        </a>
                                                    </div>
                                                    <div class="level-right">
                                                        <button type="button" class="delete" onclick="delete_review('${review["_id"]}')">삭제</button>
                                                    </div>
                                                </nav>
                                            </div>
                                        </article>
                                    </div>`
                            $("#post-box").append(html_temp)
                        }
                    }
                }
            })
        }

        $(document).ready(function () {
            get_posts()
        })
    </script>

</head>
<body>
<div class="myPic">
    <img src="{{ item['image'] }}" alt="">
</div>
<section class="section is-small">
    <h1 class="title">{{ item['title'] }}</h1>
    <h2 class="subtitle">
        제품 가격: {{ item['price'] }}원
    </h2>
</section>
<nav class="navbar is-fixed-top is-white" role="navigation" aria-label="main navigation">
    <div class="navbar-brand">
        <a class="navbar-item" href="/">
            <strong class="is-sparta"
                    style="font-family: 'Stylish', sans-serif;font-size: larger;">HAMUBARA</strong>
        </a>
    </div>
</nav>
<section class="section">
    <article class="media">
        <figure class="media-left" style="align-self: center">
            <a class="image is-32x32" href="#">
                <img class="is-rounded" src="{{ url_for('static', filename='image/profile_pics/basic_profile.png') }}">
            </a>
        </figure>
        <div class="media-content">
            <div class="field">
                <p class="control">
                    <input id="input-post" class="input is-rounded" placeholder="무슨 생각을 하고 계신가요?"
                           onclick='$("#modal-post").addClass("is-active")'></p>
            </div>
        </div>
    </article>
    <div class="modal" id="modal-post">
        <div class="modal-background" onclick='$("#modal-post").removeClass("is-active")'></div>
        <div class="modal-content">
            <div class="box">
                <article class="media">
                    <div class="media-content">
                        <div class="field">
                            <p class="control">
                                        <textarea id="textarea-post" class="textarea"
                                                  placeholder="무슨 생각을 하고 계신가요?"></textarea>
                            </p>
                        </div>
                        <nav class="level is-mobile">
                            <div class="level-left">

                            </div>
                            <div class="level-right">
                                <div class="level-item">
                                    <a class="button is-sparta" onclick="post()">포스팅하기</a>
                                </div>
                                <div class="level-item">
                                    <a class="button is-sparta is-outlined"
                                       onclick='$("#modal-post").removeClass("is-active")'>취소</a>
                                </div>
                            </div>
                        </nav>
                    </div>
                </article>
            </div>
        </div>
        <button class="modal-close is-large" aria-label="close"
                onclick='$("#modal-post").removeClass("is-active")'></button>
    </div>
</section>

<section class="section"></section>
<section class="section">
    <div id="post-box" class="container"></div>
</section>
</body>
</html>